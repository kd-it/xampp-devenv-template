# データベースの初期化タイミングと再初期化

本開発コンテナーでは、その環境を最初に構築した際にデータベースを作成します。
一度作成すると、以降は開発コンテナーを破棄しない限りデータベースは残ります。
そのため、一度終了(vscodeを閉じるなど)しても次の開発コンテナー起動時に再現されます。

## いつ初期化されるのか?

以下の状況ではデータベースの内容は初期化(消去)されてしまいます。

- Docker環境(Docker Desktop等)をアンインストールして、再度インストールした場合
- 意図的に開発コンテナーおよび周辺環境を消去した場合
    - 周辺環境: データベース用の内部ストレージやコンテナ間ネットワーク等
- 意図的にボリュームを調べて破棄した場合
    - 破棄できるのは開発コンテナーが止まっているときのみです(稼働中は拒否されます)

例えばデータベース内のテーブル構造および初期データを準備しておくと、開発コンテナーを意図的に消去して作り直すことでデータベースはリセットできます。その際に初期化用のSQL文を用意することで、初回起動の際にデータベース内にテーブルや初期値をセットしておくことができます。
このテクニックは、グループでの開発の際に、データベースの構造を揃える目的で使うこともできます。

1. メンバーの誰かが初期構造を作成する
2. 開発コンテナーを一度削除する
3. 設定用SQL文のファイルを調整し、メンバー間で共有する
4. 各メンバーが開発コンテナーを(再度)立ち上げる

これで初期構造を揃えることができます。

## 初期構造・データを配置する手順

### 初期化の前に開発コンテナーから抜ける

開発コンテナーから抜けて、ホスト側の処理に戻ってください。

1. コマンドパレットを開く
2. `Reopen folder locally` を選びます

```{image} images/vscode-reopen-locally.png
:alt: Reopen folder locally
:width: 50%
:align: center
```

これで左下の「開発コンテナー…」の部分が通常の表示に戻ります。

### 初期化用のSQLファイルを配置する

用意した初期化用のSQLファイルを、`db`ディレクトリに配置してください。

```{warning}
もしSQLファイルに手を入れた場合、構文エラーや論理的なエラー(型に合わないデータを入れようとしたりする等)があるとコンテナーが初期化に失敗して起動しなくなります。

`db`ディレクトリから外して再度開発コンテナーを起動すれば動くと思いますが、できるだけエクスポートしたファイルをそのまま持ち込めるよう、エクスポート前に初期状態を確認してから行うようにしてください。
```

ここでは、[エクスポート](#export)の際にダウンロードした`SAMPLE.sql`ファイルを配置しておきます。

```{image} images/set-file.png
:alt: `SAMPLE.sql`を`db`ディレクトリに配置
:width: 50%
:align: center
```

### 開発コンテナーの破棄

開発コンテナーは終了してもシステムに残っています(次の起動に備えている)。
これを破棄することで、データベース用のボリュームも破棄することができます。

1. vscode内でターミナルを開きます(`Create New Terminal` もしくは「ターミナル」ビューにて「+」ボタンを押す)
2. 以下のコマンドを入力します(PowerShellのプロンプトを想定しています)
3. 破棄が完了します

```pwsh
PS> docker compose down --remove-orphans -v
```

```{image} images/remove-devcontainers.png
:alt: 開発コンテナーの破棄
:width: 90%
:align: center
```

この操作で、データベース用ストレージ(volume)も含めてすべて破棄されています。

### 開発コンテナーを再生成する

この状態で、再び開発コンテナーを再度作成してください。

1. `Rebuild and reopen in container`
2. `PHP開発環境`

初期化から行われるため少し時間がかかります(イメージは存在しているはずなので初回ほどはかかりません)。
この状態で新たに開かれたポートからphpMyAdminに接続すると、最初からエクスポートした内容が入っているはずです。
